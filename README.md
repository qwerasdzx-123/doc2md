# DOC to Markdown 转换工具使用说明

## 简介

这是一个用于将 Microsoft Word `.doc` 格式文件转换为 Markdown 格式的 Python 工具。该工具支持：

- 自动提取文档中的文本内容
- 提取文档中的图片并保存到指定图床目录
- 自动识别并添加 Markdown 标题格式（一级、二级标题）
- 识别并格式化代码块
- 智能清理乱码和无关字符
- 使用相对路径引用图片

## 环境要求

- Python 3.6+
- 依赖库：
  - olefile
  - Pillow (PIL)
  - chardet

## 安装依赖

```bash
pip install olefile Pillow chardet
```

## 使用方法

### 基本使用

1. 将 `convert_doc_to_md.py` 脚本放在包含 `.doc` 文件的目录中
2. 在命令行中运行脚本：

```bash
python convert_doc_to_md.py
```

3. 脚本会自动：
   - 扫描当前目录下的所有 `.doc` 文件
   - 为每个文件创建对应的 `.md` 文件
   - 提取图片并保存到 `D:\0-MD图床` 目录
   - 在 Markdown 文件中添加图片引用

### 自定义配置

如需修改图床路径，请编辑脚本中的 `process_doc_files()` 函数：

```python
image_dir = r'D:\0-MD图床'  # 修改为你想要的图床路径
```

## 功能特性

### 文本提取

- 使用 olefile 库直接解析 `.doc` 文件的 OLE 结构
- 自动检测文本编码（支持 UTF-16LE、GB2312、GBK、UTF-8 等）
- 智能提取 WordDocument 流中的文本内容

### 图片提取

- 自动识别并提取文档中的图片
- 支持 PNG、JPEG 等常见图片格式
- 图片按文件名编号保存（如：`文件名_1.png`）
- 自动获取图片尺寸信息

### Markdown 格式化

#### 标题识别

- 自动识别文档中的标题行
- 添加一级标题（`#`）和二级标题（`##`）
- 保持文档原有的层级结构

#### 代码块识别

- 识别命令行代码和程序代码
- 自动添加代码块标记（` ``` `）
- 保留代码的原始格式

#### 文本清理

- 移除二进制字符和无关符号
- 清理乱码字符（包括特殊 Unicode 字符）
- 保留中文、英文、数字和常用标点符号
- 智能合并重复内容

### 图片引用

- 使用相对路径引用图片
- 格式：`![图片N](../0-MD图床/文件名_N.png)`
- 在 Markdown 文件末尾添加图片区域

## 输出示例

### 输入文件

- `Google语法.doc`（包含 4 张图片）

### 输出文件

- `Google语法.md`（Markdown 格式）
- `D:\0-MD图床\Google语法_1.png`
- `D:\0-MD图床\Google语法_2.png`
- `D:\0-MD图床\Google语法_3.png`
- `D:\0-MD图床\Google语法_4.png`

### Markdown 输出示例

```markdown
# 语法

将返回所有和这个站有关的
搜索我们指定的字符是否存在于
将返回所有网页标题中包含关键词的网页

## intitle:index.of

服务器的版本制定有针对性的攻击

## intitle:index.of  Apache/1.3.27 Server at

经常会出现 页面的备份文件 有泄露源码的倾 常常会在配置错误的时候出现这种问题

## 图片

![图片1](../0-MD图床/Google语法_1.png)

![图片2](../0-MD图床/Google语法_2.png)
```

## 转换流程

1. **文件扫描**：查找当前目录下所有 `.doc` 文件
2. **图片提取**：从 OLE 结构中提取图片数据
3. **文本提取**：从 WordDocument 流中提取文本
4. **编码检测**：使用 chardet 检测文本编码
5. **文本清理**：移除乱码和无关字符
6. **格式化**：添加 Markdown 标题和代码块
7. **图片引用**：在 Markdown 中添加图片链接
8. **保存文件**：写入 `.md` 文件

## 注意事项

1. **文件格式**：仅支持 `.doc` 格式，不支持 `.docx` 格式
2. **临时文件**：跳过以 `~$` 开头的临时文件
3. **图床目录**：确保图床目录有写入权限
4. **编码问题**：如果文本提取不正确，可能需要手动调整编码检测逻辑
5. **图片格式**：某些特殊格式的图片可能无法提取

## 故障排除

### 问题：无法提取文本

**解决方案**：
- 检查 `.doc` 文件是否损坏
- 确认文件是真正的 `.doc` 格式（而非 `.docx`）
- 尝试用 Microsoft Word 打开文件确认内容

### 问题：图片无法提取

**解决方案**：
- 确认文档中确实包含图片
- 检查图床目录是否有写入权限
- 某些嵌入的图片可能使用了特殊格式

### 问题：乱码问题

**解决方案**：
- 脚本已内置乱码清理功能
- 如仍有乱码，可以编辑 `clean_uncommon_chinese()` 函数添加需要过滤的字符
- 检查原始文件的编码格式

### 问题：标题识别不准确

**解决方案**：
- 编辑 `format_markdown()` 函数调整标题识别逻辑
- 根据实际文档格式修改判断条件

## 技术细节

### OLE 文件解析

使用 `olefile` 库解析 `.doc` 文件的复合文档二进制格式（CDF）：

- 读取 `WordDocument` 流提取文本
- 扫描 `Data` 流查找图片签名（PNG、JPEG 等）
- 解析图片数据并保存为独立文件

### 编码检测

使用 `chardet` 库自动检测文本编码：

- 优先尝试 UTF-16LE（.doc 文件常用编码）
- 回退到 GB2312、GBK、UTF-8 等编码
- 根据中文字符比例选择最佳编码

### 文本清理算法

- 使用正则表达式匹配中文字符：`[\u4e00-\u9fff]`
- 过滤特殊 Unicode 字符和乱码
- 保留 ASCII 可打印字符和中文标点
- 智能合并重复内容

## 许可证

本工具为开源项目，可自由使用和修改。

## 贡献

欢迎提交问题和改进建议！

## 更新日志

### v1.0.0
- 初始版本
- 支持基本的 .doc 到 Markdown 转换
- 支持图片提取
- 支持标题和代码块格式化
- 内置乱码清理功能